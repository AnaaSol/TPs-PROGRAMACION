from flask import Flask, render_template, request, redirect, url_for, abort, flash, session
from flask_login import login_user, login_required, current_user, logout_user
from werkzeug.security import generate_password_hash, check_password_hash
from modulos.gestores import Gestor_de_base_de_datos, Gestor_de_reclamos
from modulos.usuario import Usuario
import datetime

from functools import wraps
from modulos.config import app, db, login_manager
from modulos.databases import *

from sqlalchemy.orm.exc import NoResultFound 

GestorDB=Gestor_de_base_de_datos()
#GestorR=Gestor_de_reclamos('modulos/ClasificadorSk/clasificadorsk/objeto_clasificador.pkl') #error can't get atribute 'Clasificador' on module __main__ from server

admin_list = [1]

with app.app_context():
    db.create_all()

@login_manager.user_loader
def user_loader(user_id):
    return Persona_db.query.get(user_id)
    
@app.route("/", methods=['GET', 'POST'])
def raiz():  
    condicion=""
    if request.method == 'POST':
        u=request.form["usuario"]
        c=request.form["contraseña"] 
        if not u or not c:
            condicion="Complete ambos campos"
        else:
            try:
                actual_password=GestorDB.get_dato_user(u, "password") #contraseña correcta del usuario
            # except Exception as e: #either el usuario no existe o el dato es inválido (el dato es válido, está chequeado)
            #     condicion=str(e)
            except:
                condicion="El usuario no existe"
            else: #bloque que se ejecuta si en try no hubo excepción
                if actual_password==c: #compara la contraseña correcta con la ingresada
                    type=GestorDB.get_dato_user(u, "depto") 
                    if not type: #es decir, type=None
                        return redirect(url_for('usuario', user=u)) 
                    else:
                        return redirect(url_for('jefe', depto=type))
                else:
                    condicion="La contraseña es incorrecta"

    return render_template("main.html", condicion=condicion)

@app.route("/sing_up", methods=['GET', 'POST'])
def new_user():
    condicion=""
    if request.method == 'POST':
        name=request.form["name"]
        apellido=request.form["surname"]
        mail=request.form["email"]
        user_name=request.form["username"]
        cloister=request.form["cloister"]
        contraseña=request.form["password"]
        rep_contraseña=request.form["password_again"]

        if not name or not apellido or not mail or not user_name or not cloister or not contraseña or not rep_contraseña:
            condicion="Faltan ingresar datos. Por favor complete todos los campos"

        elif GestorDB.chequear_disponibilidad("email", mail)=="Email/usuario ocupado":
            condicion="Ya existe una cuenta con ese email"

        elif GestorDB.chequear_disponibilidad("username", user_name)=="Email/usuario ocupado":
            condicion="Ya existe una cuenta con ese nombre de usuario"
        
        elif contraseña!=rep_contraseña:
            condicion="Las contraseñas ingresadas no coinciden"

        else:
            #ID_inicializador=0 #no se guarda, la base de datos le asigna uno al guardar el usuario
            #user=Usuario(ID_inicializador, name, apellido, user_name, mail, contraseña, cloister)
            #estructura de desglose del método= name, surname, username, email, password +claustro/depto
            datos_user=[name, apellido, mail, user_name, contraseña, cloister, "", ""]
            GestorDB.guardar_nuevo_objeto("usuario", datos_user)
            return redirect(url_for('raiz'))
            #¿deberíamos mostrar un mensaje de registro o direccionar a usuario directamente?
    
    return render_template("sing_up.html", condicion=condicion)

@app.route("/jefe/<depto>", methods=['GET', 'POST'])
def jefe(depto):
    return render_template("jefe.html", depto=depto)

@app.route("/usuario/<user>", methods=['GET', 'POST'])
def usuario(user):
    #Almacena el nombre de usuario en la sesión
    
    session['username']=user #chequear
    username=user
    return render_template("usuario.html", user=username)

@app.route("/reclamo", methods=['GET', 'POST'])
def crear():
    if request.method == "POST":
        username=session.get('username')
        id_user=GestorDB.get_dato_user(username, "ID")
        texto=request.form["description"]
        imagen=request.files["image"]
        data=[texto, "pendiente", "", str(datetime.datetime.now())[:19], 0, id]
        if imagen:
            imagen_data = imagen.read()
        reclamo=GestorDB.guardar_nuevo_objeto("reclamo", data) #sin clasificar
        id_reclamo=GestorDB.get_dato_reclamo(reclamo, "ID_reclamo")
        fecha=GestorDB.get_dato_reclamo(reclamo, "timestap")
        form=[id_reclamo, texto, fecha, id_user]
        recl=GestorR.crear_reclamo(form)
        GestorR.clasificar_reclamo(recl)
        reclamos_same_depto=GestorDB.get_reclamos_filtrados_data(recl.get_departamento())
        
        #clasificar reclamo y proponer similares (¿la función debería estar en funciones o en GestorDB?)

    return render_template("reclamo.html")

@app.route("/reclamos_pendientes", methods=['GET', 'POST'])
def pendientes():
    username=session.get('username')
    reclamos = GestorDB.get_reclamo_by_filtro() #al no pasarle un parametro devuelve todos los reclamos
    return render_template("reclamos_pendientes.html", reclamos=reclamos)

@app.route("/reclamos_usuario", methods=['GET', 'POST'])
def recl():
    username=session.get('username')
    # id=GestorDB.get_dato_user(username, "ID")
    # name=GestorDB.get_dato_user(username, "name")
    # apellido=GestorDB.get_dato_user(username, "surname")
    # user_name=GestorDB.get_dato_user(username, "username")
    # mail=GestorDB.get_dato_user(username, "email")
    # contraseña=GestorDB.get_dato_user(username, "password")
    # cloister=GestorDB.get_dato_user(username, "claustro")
    # user=Usuario(id, name, apellido, user_name, mail, contraseña, cloister)
    reclamos_usuario=GestorDB.reclamos_de_user(username)
    return render_template("reclamo_usuario.html", reclamos_usuario=reclamos_usuario)

@app.route("/reclamos_departamento", methods=['GET', 'POST'])
def responder():
    return render_template("reclamo_depto.html")

if __name__ == "__main__":
    app.run(debug=True)